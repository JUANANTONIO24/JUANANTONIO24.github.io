<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Restaurante</title>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database.js"></script>

    <style>
      /* Tus estilos aquí (idénticos a los que ya tenías) */
      body { font-family: Arial, sans-serif; /* ... */ }
      .environment { display: none; /* ... */ }
      .environment.active { display: block; /* ... */ }
      /* Resto de tu CSS... */
    </style>
</head>
<body>

  <!-- Botón cerrar sesión -->
  <div style="text-align:right; margin:20px;">
    <button onclick="logout()">Cerrar Sesión</button>
  </div>

  <!-- Selector de entornos -->
  <div class="environment-selector">
    <button class="env-button active" onclick="switchEnvironment('admin')">👨‍💼 Administración</button>
    <button class="env-button" onclick="switchEnvironment('waiter')">🍽️ Mesero</button>
    <button class="env-button" onclick="switchEnvironment('kitchen')">👨‍🍳 Cocina</button>
    <button class="env-button" onclick="switchEnvironment('cashier')">💰 Caja</button>
  </div>

  <!-- Entorno Administración -->
  <div id="admin" class="environment active">
    <!-- Dashboard, gestión de menú, etc. (igual a tu código) -->
  </div>

  <!-- Entorno Mesero -->
  <div id="waiter" class="environment">
    <!-- Nueva Orden y Órdenes Activas -->
  </div>

  <!-- Entorno Cocina -->
  <div id="kitchen" class="environment">
    <div class="grid">
      <div class="card">
        <h3>🔥 Órdenes Pendientes</h3>
        <div id="ordenesPendientes"></div>
      </div>
      <div class="card">
        <h3>👨‍🍳 En Preparación</h3>
        <div id="ordenesPreparando"></div>
      </div>
      <div class="card">
        <h3>✅ Listas para Servir</h3>
        <div id="ordenesListas"></div>
      </div>
    </div>
  </div>

  <!-- Entorno Caja -->
  <div id="cashier" class="environment">
    <!-- Procesar Pago y Resumen de Caja -->
  </div>

  <!-- Modal detalles de orden -->
  <div id="modalOrden" class="modal">
    <div class="modal-content">
      <span class="close" onclick="cerrarModal()">&times;</span>
      <div id="detallesOrden"></div>
    </div>
  </div>

  <script>
    // --- Sesión ---
    function logout() {
      sessionStorage.removeItem("autenticado");
      window.location.href = "index.html";
    }

    // --- Globales ---
    let menu = [ /* ... */ ];
    let empleados = [ /* ... */ ];
    let ordenes = [];
    let ventas = [];
    let ordenActual = null;
    let contadorOrden = 1;

    let isAdminAuthenticated = false;
    const adminPassword = 'Admin123';

    // --- Firebase Init ---
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_DOMINIO.firebaseapp.com",
      databaseURL: "https://TU_PROJECT_ID-default-rtdb.firebaseio.com",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_PROJECT_ID.appspot.com",
      messagingSenderId: "TU_SENDER_ID",
      appId: "TU_APP_ID"
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db  = firebase.database();

    // --- Función para guardar/actualizar orden en Firebase ---
    function guardarOrdenFirebase(orden) {
      db.ref("ordenes/" + orden.id).set(orden);
    }

    // --- Listener que carga todas las órdenes en cocina ---
    function escucharOrdenesFirebase() {
      db.ref("ordenes").on("value", snapshot => {
        ordenes = [];
        snapshot.forEach(childSnap => {
          ordenes.push(childSnap.val());
        });
        cargarOrdenesCocina();
      });
      // Opcional: sincroniza cambios de estado en Mesero/Caja
      db.ref("ordenes").on("child_changed", snapshot => {
        const ord = snapshot.val();
        const idx = ordenes.findIndex(o => o.id === ord.id);
        if (idx >= 0) ordenes[idx] = ord;
        cargarOrdenesActivas();
        cargarOrdenesCaja();
      });
    }

    // --- Switch entre entornos ---
    function switchEnvironment(env) {
      document.querySelectorAll('.environment').forEach(e => e.classList.remove('active'));
      document.querySelectorAll('.env-button').forEach(b => b.classList.remove('active'));
      document.getElementById(env).classList.add('active');
      event.target.classList.add('active');

      if (env === 'admin') {
        if (!isAdminAuthenticated && !authenticateAdmin()) return;
        actualizarDashboard(); cargarMesas();
      }
      if (env === 'waiter') {
        cargarMenuMesero(); cargarOrdenesActivas();
      }
      if (env === 'kitchen') {
        escucharOrdenesFirebase();
      }
      if (env === 'cashier') {
        cargarOrdenesCaja(); actualizarResumenCaja();
      }
    }

    function authenticateAdmin() {
      const pwd = prompt('Contraseña admin:');
      if (pwd === adminPassword) {
        isAdminAuthenticated = true;
        mostrarNotificacion('Acceso concedido','success');
        return true;
      }
      mostrarNotificacion('Contraseña incorrecta','error');
      return false;
    }

    // --- Mesero: crear orden ---
    function crearOrden() {
      const mesa = document.getElementById('mesaOrden').value;
      const cliente = document.getElementById('clienteNombre').value.trim();
      if (!cliente) return mostrarNotificacion('Cliente requerido','error');

      ordenActual = {
        id: contadorOrden++,
        mesa, cliente,
        observaciones: document.getElementById('observaciones').value,
        items: [], estado: 'pendiente',
        fecha: new Date().toISOString(), total: 0
      };
      guardarOrdenFirebase(ordenActual);
      mostrarNotificacion('Orden creada','success');
    }

    function agregarAOrden(itemId) {
      if (!ordenActual) return mostrarNotificacion('Crea la orden primero','error');
      const item = menu.find(m => m.id===itemId);
      const ex = ordenActual.items.find(i=>i.id===itemId);
      if (ex) ex.cantidad++;
      else ordenActual.items.push({...item, cantidad:1});
      ordenActual.total = ordenActual.items.reduce((s,i)=>s+i.precio*i.cantidad,0);
      guardarOrdenFirebase(ordenActual);
     mostrarNotificacion(item.nombre+' agregado','success');
      cargarOrdenesActivas();
    }

    function cargarOrdenesActivas() {
      const tb = document.getElementById('ordenesActivas');
      tb.innerHTML='';
      ordenes.filter(o=>o.estado!=='pagado').forEach(o=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${o.id}</td><td>${o.mesa}</td>
          <td>${o.cliente}</td>
          <td><span class="status ${o.estado}">${o.estado}</span></td>
          <td>$${o.total.toFixed(2)}</td>
          <td>
            <button class="btn btn-primary" onclick="verDetallesOrden(${o.id})">Ver</button>
            <button class="btn btn-danger" onclick="cancelarOrden(${o.id})">Cancelar</button>
          </td>`;
        tb.appendChild(tr);
      });
    }

    // --- Cocina ---
    function cargarOrdenesCocina() {
      cargarOrdenesPorEstado('pendiente','ordenesPendientes');
      cargarOrdenesPorEstado('preparando','ordenesPreparando');
      cargarOrdenesPorEstado('listo','ordenesListas');
    }

    function cargarOrdenesPorEstado(estado, contId) {
      const cont = document.getElementById(contId);
      cont.innerHTML='';
      ordenes.filter(o=>o.estado===estado).forEach(o=>{
        const div=document.createElement('div');
        div.className='card';
        div.innerHTML=`
          <h4>Orden #${o.id} - Mesa ${o.mesa}</h4>
          <p><strong>Cliente:</strong> ${o.cliente}</p>
          <p><strong>Items:</strong> ${o.items.map(i=>i.nombre+' x'+i.cantidad).join(', ')}</p>
          <p><strong>Obs:</strong> ${o.observaciones||'–'}</p>
          <p><strong>Total:</strong> $${o.total.toFixed(2)}</p>
          <div>
            ${estado==='pendiente' ?
              `<button class="btn btn-warning" onclick="cambiarEstadoOrden(${o.id},'preparando')">Iniciar</button>`
            : estado==='preparando' ?
              `<button class="btn btn-success" onclick="cambiarEstadoOrden(${o.id},'listo')">Listo</button>`
            : ''}
            ${estado==='listo' ?
              `<button class="btn btn-primary" onclick="cambiarEstadoOrden(${o.id},'entregado')">Entregado</button>`
            : ''}
          </div>`;
        cont.appendChild(div);
      });
    }

    function cambiarEstadoOrden(id, nuevo) {
      const o = ordenes.find(x=>x.id===id);
      if (!o) return;
      o.estado = nuevo;
      guardarOrdenFirebase(o);
      cargarOrdenesCocina();
      cargarOrdenesActivas();
      cargarOrdenesCaja();
      mostrarNotificacion(`Orden ${id} → ${nuevo}`,'success');
    }

    // --- Caja ---
    function cargarOrdenesCaja() {
      const sel = document.getElementById('ordenPago');
      sel.innerHTML='<option value="">Seleccione</option>';
      ordenes.filter(o=>o.estado==='entregado').forEach(o=>{
        const opt=document.createElement('option');
        opt.value=o.id;
        opt.textContent=`#${o.id} Mesa ${o.mesa} $${o.total.toFixed(2)}`;
        sel.appendChild(opt);
      });
      sel.onchange = ()=> document.getElementById('montoPago').value =
        (ordenes.find(x=>x.id==sel.value)?.total||0).toFixed(2);
    }

    function procesarPago() {
      const id = +document.getElementById('ordenPago').value;
      const pago = +document.getElementById('montoCliente').value;
      const total = +document.getElementById('montoPago').value;
      if (!id || pago<total) return mostrarNotificacion('Revisa pago','error');
      const ord = ordenes.find(x=>x.id===id);
      const cambio = pago-total;
      document.getElementById('montoCambio').value = `$${cambio.toFixed(2)}`;
      ventas.push({ordenId:id,fecha:new Date(),monto:total,metodoPago:document.getElementById('metodoPago').value});
      ord.estado='pagado'; guardarOrdenFirebase(ord);
      mostrarNotificacion('Pago OK','success');
      cargarOrdenesCaja(); actualizarResumenCaja(); cargarHistorialPagos(); actualizarDashboard(); cargarMesas();
    }

    // --- Dashboard y utilidades ---
    function actualizarResumenCaja() { /* ... */ }
    function cargarHistorialPagos() { /* ... */ }
    function actualizarDashboard()  { /* ... */ }
    function cargarMesas()          { /* ... */ }
    function cargarMenuMesero()     { /* ... */ }
    function verDetallesOrden(id)   { /* ... */ }
    function cancelarOrden(id)      { /* ... */ }
    function mostrarNotificacion(msg, type) { /* ... */ }
    function generarReporte(){ /* ... */ }
    function descargarReporte(){ /* ... */ }

    // --- Inicio ---
    document.addEventListener('DOMContentLoaded',()=>{
      cargarMenuMesero();
      actualizarDashboard();
      cargarMesas();
    });
  </script>
</body>
</html>
